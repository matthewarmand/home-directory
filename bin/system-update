#!/bin/sh -e

message() {
  printf "\033[1m\e[35m::\e[0m \033[1m%s\033[0m\n" "$1"
}

message "Checking for relevant news..."
paru -Syu --newsonupgrade --review --removemake

message "Updating Oh My Zsh..."
if (zsh -c "omz update --unattended") | grep -q "has been updated"; then
  zsh -c "omz changelog"
fi

message "Removing orphaned packages..."
paru -c

message "Merging configuration file updates..."
pacdiff -b -s

message "Cleaning package caches..."
paccache_args="-k 3 -r -c $(pacman-conf CacheDir)"
for d in "${XDG_CACHE_HOME:-$HOME/.cache}"/paru/clone/*/; do
  paccache_args="$paccache_args -c $d"
done
eval "paccache $paccache_args"

running_kernel=$(uname -r | sed -E 's/(\.0)?-arch/.arch/')
installed_kernel=$(paru -Q linux | awk '{print $2}')
if [ "$running_kernel" != "$installed_kernel" ]; then
  message "$(printf "Kernel has been updated from \e[32m%s\e[0m\033[1m to \e[32m%s\e[0m\033[1m; (R)eboot, (S)hutdown, or (Q)uit now? [R/s/q] " "$running_kernel" "$installed_kernel")"
  while true; do
    read -r rsq
    if [ -z "$rsq" ]; then
      rsq='r'
    fi
    case $rsq in
      [Rr]*) reboot ;;
      [Ss]*) shutdown -h +0 ;;
      [Qq]*) break ;;
      *) printf "\e[31mPlease answer r, s, or q.\e[0m\n" ;;
    esac
  done
fi
