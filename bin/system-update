#!/bin/bash -e

message() {
  echo -e "\033[1m\e[35m::\e[0m \033[1m$1\033[0m"
}

# Check security audit for fixed packages; this may make the upgrade more urgent/desirable
message "Checking for available security fixes..."
arch-audit -uc

# Full system update
message "Checking for relevant news..."
trap "" SIGINT SIGTERM SIGTSTP
paru -Syu --newsonupgrade --review --removemake
trap - SIGINT SIGTERM SIGTSTP

message "Removing orphaned packages..."
paru -c

message "Merging configuration file updates..."
sudo pacdiff

message "Cleaning package caches..."
paccache_cmd="paccache -r -k 3 -c $(grep CacheDir /etc/pacman.conf | sed 's/^.*= //')"
for d in "${XDG_CACHE_HOME:-$HOME/.cache}"/paru/clone/*/; do
  paccache_cmd="$paccache_cmd -c $d"
done
$paccache_cmd

# Check for kernel upgrade; request restart
if [ "$(uname -r)" != "$(paru -Q linux | awk '{print $2}' | sed 's/\.arch/-arch/')" ]; then
  message "Kernel has been upgraded; reboot now? [Y/n] "
  while true; do
    read -r yn
    if [ -z "$yn" ]; then
      yn='y'
    fi
    case $yn in
      [Yy]*) reboot ;;
      [Nn]*) break ;;
      *) echo "Please answer y or n." ;;
    esac
  done
fi
