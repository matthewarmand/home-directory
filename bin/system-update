#!/bin/sh -e

message() {
  printf "\033[1m\e[35m::\e[0m \033[1m%s\033[0m\n" "$1"
}

message "Checking for relevant news..."
paru -Syu --newsonupgrade --review --removemake

message "Updating Oh My Zsh..."
if (zsh -c "omz update --unattended") | grep -q "has been updated"; then
  zsh -c "omz changelog"
fi

message "Removing orphaned packages..."
paru -c

message "Merging configuration file updates..."
pacdiff -b -s

message "Cleaning package caches..."
package_dirs="-c $(pacman-conf CacheDir)"
for d in "${XDG_CACHE_HOME:-$HOME/.cache}"/paru/clone/*/; do
  package_dirs="$package_dirs -c $d"
done
eval "paccache -r -k 3 $package_dirs"

running_kernel=$(uname -r | sed -E 's/(\.0)?-arch/.arch/')
installed_kernel=$(paru -Q linux | awk '{print $2}')
if [ "$running_kernel" != "$installed_kernel" ]; then
  message "$(printf "Kernel has been updated from \e[32m%s\e[0m\033[1m to \e[32m%s\e[0m\033[1m. Enter R to reboot (default), S to shutdown, or anything else to exit." "$running_kernel" "$installed_kernel")"
  read -r answer
  if [ -z "$answer" ]; then
    answer='r'
  fi
  case $answer in
    [Rr]*) reboot ;;
    [Ss]*) shutdown -h +0 ;;
  esac
fi
